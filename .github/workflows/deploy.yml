name: Build & Deploy (prod)

on:
  push:
    branches: ["main"] # 你的默认分支叫 main 就不用改；若是 master 就写 master
  workflow_dispatch: # 允许手动触发

concurrency:
  group: deploy-prod
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          # 只构建 amd64（你的服务器是 x86_64）
          platforms: linux/amd64
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/mlogger:prod
            ${{ secrets.DOCKERHUB_USERNAME }}/mlogger:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/mlogger:prod
          cache-to: type=inline

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: SSH to server & deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -euo pipefail

            echo "Pulling latest prod image (best-effort)..."
            if ! podman pull docker.io/${{ secrets.DOCKERHUB_USERNAME }}/mlogger:prod; then
              echo "WARN: pull failed, will try to use cached image."
            fi

            # 没有本地镜像就直接报错退出（避免起不来还不自知）
            if ! podman image exists docker.io/${{ secrets.DOCKERHUB_USERNAME }}/mlogger:prod; then
              echo "ERROR: prod image not present locally and pull failed. Abort."
              exit 1
            fi

            echo "Restarting service..."
            systemctl restart container-mlogger-blue

            echo "Health check..."
            sleep 3
            # 直连容器检查：允许 200 或 302
            if ! curl -sI http://127.0.0.1:18081/ | head -n1 | grep -E ' 200| 302' > /dev/null; then
              echo "Container health check failed. Recent logs:"
              journalctl -u container-mlogger-blue -n 120 --no-pager || true
              exit 1
            fi
            # 经 Nginx 检查
            if ! curl -sI http://127.0.0.1/ | head -n1 | grep -E ' 200| 302' > /dev/null; then
              echo "Nginx check failed. Nginx error log tail:"
              tail -n 80 /var/log/nginx/error.log || true
              exit 1
            fi
            echo "Deploy OK."
